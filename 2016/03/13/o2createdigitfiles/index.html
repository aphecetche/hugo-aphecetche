<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>O2 - Creating MCH digit files from filtered RAW data &middot; Laurent Aphecetche</title>
        <meta name="description" content="">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="generator" content="Hugo 0.15" />
        <meta name="robots" content="index,follow">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="http://aphecetche.github.io/css/normalize.css">
        <link rel="stylesheet" href="http://aphecetche.github.io/css/highlight.css">
        <link rel="stylesheet" href="http://aphecetche.github.io/css/style.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    </head>
    <body>
        

        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                        
                            <h1 class="site-title">
                                <a title="Laurent Aphecetche - High Energy Collisions Investigator" href="http://aphecetche.github.io/">Laurent Aphecetche - High Energy Collisions Investigator</a>
                            </h1>
                        
                        
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Github" title="Github" href="https://github.com/aphecetche">
                                <i class="fa fa-github"></i>
                            </a>
                        
                        
                        
                        
                    </div>

                        

                    <ul class="site-nav">
                        
    <li class="site-nav-item">
        <a title="Reco on SAF3" href="/saf3-reco/">Reco on SAF3</a>
    </li>

    <li class="site-nav-item">
        <a title="SAF3 User Manual" href="/saf3-usermanual/">SAF3 User Manual</a>
    </li>

                    </ul>
                </div>
            </header>

            <div id="container">


<div class="container">
    <article class="post-container" itemscope="" itemtype="http://schema.org/BlogPosting">

        <header class="post-header">
    <h1 class="post-title" itemprop="name headline">O2 - Creating MCH digit files from filtered RAW data</h1>
    
    <p class="post-date">
        <span><time datetime="2016-03-13" itemprop="datePublished">Sun, Mar 13, 2016</time></span>
    </p>
</header>


        <div class="post-content clearfix" itemprop="articleBody">
    

    <p>First, get the code from AliRoot (feature-muonhlt) branch in MUON/MUON2 directory, and put it on SAF3</p>

<pre><code class="language-bash">sshfs -o ssh_command=&quot;gsissh -p1975&quot; nansafmaster3.in2p3.fr:/home/laphecet ~/saf3
mkdir -p $HOME/saf3/o2
cp $ALICE_ROOT/../src/MUON/MUONO2/O2Muon.* $HOME/saf3/o2
</code></pre>

<p>Check on SAF3 that the code is compiling under Root :</p>

<pre><code class="language-bash">saf3-enter
root
</code></pre>

<pre><code class="language-c++">gSystem-&gt;SetIncludePath(&quot;-I$ALICE_ROOT/include&quot;);
.L O2Muon.cxx++
</code></pre>

<p>And test on a single file that the code is behaving as expected :</p>

<pre><code class="language-bash">echo &quot;root://nansafmaster2//alice/data/2011/LHC11h/000169099/raw/11000169099032.133.FILTER_RAWMUON_WITH_ALIPHYSICS_vAN-20150213.root&quot; &gt; input.txt
</code></pre>

<pre><code class="language-c++">gSystem-&gt;SetIncludePath(&quot;-I$ALICE_ROOT/include&quot;)
.L O2Muon.cxx++
O2Muon o2m(&quot;local:///cvmfs/alice-ocdb.cern.ch/calibration/data/2011/OCDB&quot;);
o2m.makeDigitFiles(&quot;input.txt&quot;,&quot;CPBI2_B1-B-NOPF-ALLNOTRD&quot;,true);
</code></pre>

<p>Then use <code>condor</code> for the heavy lifting. Prepare a file list for a given run or part of it, in a file ending with the extension <code>.list</code></p>

<pre><code>root://nansafmaster2//alice/data/2011/LHC11h/000169099/raw/11000169099032.133.FILTER_RAWMUON_WITH_ALIPHYSICS_vAN-20150213.root
root://nansafmaster2//alice/data/2011/LHC11h/000169099/raw/11000169099063.163.FILTER_RAWMUON_WITH_ALIPHYSICS_vAN-20150213.root
root://nansafmaster2//alice/data/2011/LHC11h/000169099/raw/11000169099065.113.FILTER_RAWMUON_WITH_ALIPHYSICS_vAN-20150213.root
root://nansafmaster2//alice/data/2011/LHC11h/000169099/raw/11000169099054.124.FILTER_RAWMUON_WITH_ALIPHYSICS_vAN-20150213.root
root://nansafmaster2//alice/data/2011/LHC11h/000169099/raw/11000169099060.150.FILTER_RAWMUON_WITH_ALIPHYSICS_vAN-20150213.root
root://nansafmaster2//alice/data/2011/LHC11h/000169099/raw/11000169099065.166.FILTER_RAWMUON_WITH_ALIPHYSICS_vAN-20150213.root
...
</code></pre>

<p>Use the following <code>makedigits.condor</code> file :</p>

<pre><code class="language-bash">universe=vanilla

executable=$ENV(HOME)/o2/makedigits/makedigits.sh

# Don't send annoying email notifications
Notification = Never

# stdout and stderr of PoD jobs
Output        = makedigits.out
Error         = makedigits.err
Log           = makedigits.log

# we want to transfer files
should_transfer_files = YES
when_to_transfer_output = ON_EXIT

rank = -SlotID

Input = $ENV(HOME)/.PoD/user_worker_env.sh

include : $ENV(HOME)/o2/makedigits/list-input.sh |
</code></pre>

<p>where the <code>list-input.sh</code> script is generating the <code>queue</code> commands from any file with extension <code>.list</code>. In that file you might want to change the <code>ninput</code> parameter which decide how many files you will process per condor job.</p>

<pre><code class="language-bash">
# split by chunks of n raw files
ninput=50

for file in $(ls $HOME/o2/makedigits/*.list)
do

	n=0
	index=0

	f=$(basename $file)

	mkdir -p $HOME/o2/makedigits/$f.dir

	cd $HOME/o2/makedigits/$f.dir
	rm -rf input.*

	for l in $(cat $file)
	do
		echo $l &gt;&gt; input.$index
		(( n += 1))
		if (( $n % $ninput == 0 ))
		then
			echo &quot;transfer_input_files=\$ENV(HOME)/o2/makedigits/$f.dir/input.$index,\$ENV(HOME)/o2/O2Muon.cxx,\$ENV(HOME)/o2/O2Muon.h&quot;
			echo &quot;arguments = input.$index&quot;
			echo &quot;queue&quot;
			(( index +=1 ))
			n=0
		fi
	done
done

if (( $n &gt; 0 &amp;&amp; $n &lt; $ninput ))
then
	echo &quot;transfer_input_files=\$ENV(HOME)/o2/makedigits/$f.dir/input.$index,\$ENV(HOME)/o2/O2Muon.cxx,\$ENV(HOME)/o2/O2Muon.h&quot;
	echo &quot;arguments = input.$index&quot;
	echo &quot;queue&quot;
fi
</code></pre>

<p>And finally the script doing the job, <code>makedigits.sh</code>, which is using the <code>O2Muon</code> class from AliRoot/MUON/MUONo2 package.</p>

<pre><code class="language-bash">#!/bin/bash

source  /cvmfs/alice.cern.ch/etc/login.sh
source `which alienv` setenv VO_ALICE@AliRoot::v5-08-02-1

alienv list

echo &quot;arg=$1&quot;

pwd
ls -al

  root -b &lt;&lt; EOF
    gSystem-&gt;SetIncludePath(&quot;-I$ALICE_ROOT/include&quot;);
    .L O2Muon.cxx++
    O2Muon o2m(&quot;local:///cvmfs/alice-ocdb.cern.ch/calibration/data/2011/OCDB&quot;);
    o2m.makeDigitFiles(&quot;$1&quot;,&quot;CPBI2_B1-B-NOPF-ALLNOTRD&quot;,true);
    .q
EOF
</code></pre>

</div>


        <footer class="post-footer clearfix">
    
        <p class="post-tags">
            <span>Tagged:</span>
            
                 <a href="/tags/o2/">o2</a>
            
                 <a href="/tags/hlt/">hlt</a>
            
                 <a href="/tags/aliroot/">aliroot</a>
            
                 <a href="/tags/raw/">raw</a>
            
                 <a href="/tags/digits/">digits</a>
            
                 <a href="/tags/saf/">saf</a>
            
                 <a href="/tags/condor/">condor</a>
            
        </p>
    
</footer>


    </article>

</div>

            </div>
        </div>

        <footer class="footer">
            <div class="container">
                <div class="site-title-wrapper">
                    <h1 class="site-title">
                        <a title="Laurent Aphecetche - High Energy Collisions Investigator" href="http://aphecetche.github.io/">Laurent Aphecetche - High Energy Collisions Investigator</a>
                    </h1>
                    <a class="button-square button-jump-top js-jump-top" href="#">
                        <i class="fa fa-angle-up"></i>
                    </a>
                </div>

                <p class="footer-copyright">
                    <span>&copy; 2016 / Powered by <a href="http://gohugo.io/">Hugo</a></span>
                </p>
            </div>
        </footer>

        <script src="http://aphecetche.github.io/js/jquery-1.11.3.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js"></script>
        <script src="http://aphecetche.github.io/js/jquery.fitvids.js"></script>
        <script src="http://aphecetche.github.io/js/scripts.js"></script>
    </body>
</html>

