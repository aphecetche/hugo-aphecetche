<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>SAF3 quick-start documentation &middot; Laurent Aphecetche</title>
        <meta name="description" content="">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="generator" content="Hugo 0.15" />
        <meta name="robots" content="index,follow">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="http://aphecetche.github.io/css/normalize.css">
        <link rel="stylesheet" href="http://aphecetche.github.io/css/highlight.css">
        <link rel="stylesheet" href="http://aphecetche.github.io/css/style.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    </head>
    <body>
        

        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                        
                            <h1 class="site-title">
                                <a title="Laurent Aphecetche - High Energy Collisions Investigator" href="http://aphecetche.github.io/">Laurent Aphecetche - High Energy Collisions Investigator</a>
                            </h1>
                        
                        
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Github" title="Github" href="https://github.com/aphecetche">
                                <i class="fa fa-github"></i>
                            </a>
                        
                        
                        
                        
                    </div>

                        

                    <ul class="site-nav">
                        
    <li class="site-nav-item">
        <a title="Reco on SAF3" href="/saf3-reco/">Reco on SAF3</a>
    </li>

    <li class="site-nav-item">
        <a title="SAF3 User Manual" href="/saf3-usermanual/">SAF3 User Manual</a>
    </li>

                    </ul>
                </div>
            </header>

            <div id="container">


<div class="container">
    <article class="post-container">
        <header class="post-header">
    <h1 class="post-title">SAF3 quick-start documentation</h1>
    
</header>
        
           <div id="toc" class="clearfix">
           <nav id="TableOfContents">
<ul>
<li><a href="#connecting-to-saf3:51208290e251b852ec70f1e0643fdf91">Connecting to SAF3</a></li>
<li><a href="#getting-files-in-and-out-from-saf3:51208290e251b852ec70f1e0643fdf91">Getting files in and out from SAF3</a></li>
<li><a href="#datasets:51208290e251b852ec70f1e0643fdf91">Datasets</a></li>
<li><a href="#when-things-go-wrong:51208290e251b852ec70f1e0643fdf91">When things go wrong &hellip;</a></li>
</ul>
</nav>
           </div>
         
        <div class="post-content clearfix">
    

    

<h1 id="connecting-to-saf3:51208290e251b852ec70f1e0643fdf91">Connecting to SAF3</h1>

<p>You need to use GSISSH to connect to nansafmaster3, i.e. you will connect using your grid certificate.</p>

<p>To get gsissh (and related commands), install the Globus Toolkit. <a href="http://toolkit.globus.org/toolkit/downloads/6.0/">Version 6</a> has a Mac package.</p>

<p>Then define those two aliases in your .bashrc :</p>

<pre><code>alias gscp='gsiscp -S `which gsissh` -P 1975'
alias gssh='gsissh -p 1975'
</code></pre>

<p>To connect to saf3, use :</p>

<pre><code>grid-proxy-init
gssh nansafmaster3.in2p3.fr
</code></pre>

<p>This will work if your environment is OK. One sure way is to use Dario&rsquo;s script alice-env.sh to set it (whatever aliroot and/or aliphysics version)</p>

<p>Once you are in nansafmaster3, setup your env using :</p>

<pre><code>saf3-enter
</code></pre>

<p>the next steps are like on the <a href="https://dberzano.github.io/alice/vcaf/usersguide/">VCAF</a>. In a nutshell, once you have selected your AliPhysics (or AliRoot version) in ~/.vaf/vaf.conf, start a proof server :</p>

<pre><code>vafctl start
</code></pre>

<p>request some workers :</p>

<pre><code>vafreq 88
</code></pre>

<p>wait a bit for them to start :</p>

<pre><code>vafcount
</code></pre>

<p>then start a proof session :</p>

<pre><code>&gt; root -b
root[0] TProof::Open(&quot;pod://&quot;);
root[1] .x runXXX.C
</code></pre>

<p>Your <code>runXXX.C</code> must Upload and Enable the special AliceVaf.par package (note that you can <em>not</em> use the same as for the VAF), like this :</p>

<pre><code class="language-C++">TList *list = new TList();
list-&gt;Add(new TNamed(&quot;ALIROOT_EXTRA_LIBS&quot;, &quot;OADB:ESD&quot;));
list-&gt;Add(new TNamed(&quot;ALIROOT_ENABLE_ALIEN&quot;, &quot;1&quot;));

 TFile::Cp(&quot;https://github.com/aphecetche/aphecetche.github.io/blob/master/saf/saf3/AliceVaf.par?raw=true&quot;,&quot;AliceVaf.par&quot;);
gProof-&gt;UploadPackage(&quot;AliceVaf.par&quot;);
gProof-&gt;EnablePackage(&quot;AliceVaf&quot;);
</code></pre>

<h1 id="getting-files-in-and-out-from-saf3:51208290e251b852ec70f1e0643fdf91">Getting files in and out from SAF3</h1>

<p>You can of course simply use <code>gsiscp</code> if you&rsquo;re happy with that. But the usual way to work on an AF (well, at least that&rsquo;s the way I work)
typically involves having a text editor opened with at least the steering macro (<code>runXXX.C</code>) and the <code>AddTaskXXX.C</code>. Having to gsiscp those each time you make a modification is clearly unpractical, IMO.</p>

<p>A better option is to use <code>SSHFS</code> to mount your saf3 home on your local machine.</p>

<pre><code>sshfs -o ssh_command=&quot;gsissh -p1975&quot; nansafmaster3.in2p3.fr:/home/username ~/saf3
</code></pre>

<p>and then you can access your files on saf3 (under $HOME/~saf3 in the example above) e.g. with your local editor.</p>

<h1 id="datasets:51208290e251b852ec70f1e0643fdf91">Datasets</h1>

<p>The syntax for datasets is in principle the same as in SAF2, with a small temporary change (until the <a href="https://sft.its.cern.ch/jira/browse/ROOT-7703">root bug</a> is fixed), namely you have to add &ldquo;Mode=cache&rdquo; in the end of the query string. So, for the time being, the recommend procedure to work with a dataset is :</p>

<ul>
<li>connect to SAF2 master and issue there a ShowDataSet to check whether the dataset is staged (if not, request the staging from SAF2 as well)</li>
<li>then connect to SAF3 and use the same query but with adding &ldquo;Mode=cache&rdquo;</li>
</ul>

<p>Note that you can also use the recent interface method introduced to the <code>AliAnalysisManager</code> (commit a2d8ed5 to aliroot, Nov. 20th 2015) to use a <code>TFileCollection</code> directly (that <em>must</em> be named &ldquo;dataset&rdquo;), e.g.</p>

<pre><code class="language-C++">TFile* d = TFile::Open(&quot;dataset.root&quot;);
TFileCollection* fc = static_cast&lt;TFileCollection*&gt;(d-&gt;Get(&quot;dataset&quot;));
...
mgr-&gt;StartAnalysis(&quot;proof&quot;,fc);
</code></pre>

<p>where the <code>dataset.root</code> might be created on SAF2 or manually.</p>

<h1 id="when-things-go-wrong:51208290e251b852ec70f1e0643fdf91">When things go wrong &hellip;</h1>

<p>You may want to inspect the log files from the Proof session. For this you need to :</p>

<ol>
<li>take note of the condor master job id of your session, using condor_q</li>
<li>cd into an empty directory and use the following script to extract the logs : the first parameter is the id of step 1</li>
</ol>

<pre><code class="language-bash">#!/bin/bash

condorpid=$1

for archive in $(ls /tmp/pod-log-$USER/$condorpid/proof_log.*.tgz)
do
	tar -zvxf $archive --wildcards --no-anchored '*.log'
done

for log in $(find var -name *.log)
do
	cp $log .
done

#rm -rf var
</code></pre>

</div>
    </article>
</div>

            </div>
        </div>

        <footer class="footer">
            <div class="container">
                <div class="site-title-wrapper">
                    <h1 class="site-title">
                        <a title="Laurent Aphecetche - High Energy Collisions Investigator" href="http://aphecetche.github.io/">Laurent Aphecetche - High Energy Collisions Investigator</a>
                    </h1>
                    <a class="button-square button-jump-top js-jump-top" href="#">
                        <i class="fa fa-angle-up"></i>
                    </a>
                </div>

                <p class="footer-copyright">
                    <span>&copy; 2016 / Powered by <a href="http://gohugo.io/">Hugo</a></span>
                </p>
            </div>
        </footer>

        <script src="http://aphecetche.github.io/js/jquery-1.11.3.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js"></script>
        <script src="http://aphecetche.github.io/js/jquery.fitvids.js"></script>
        <script src="http://aphecetche.github.io/js/scripts.js"></script>
    </body>
</html>

